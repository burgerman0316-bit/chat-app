<!DOCTYPE html>
<html>
<head>
  <title>8th Grade Chat</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    #messages {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      padding: 10px;
      border-radius: 8px;
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }

    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .message-header {
      font-size: 12px;
      color: #555;
    }

    .message-content {
      font-size: 14px;
      background: #eaeaea;
      padding: 5px 10px;
      border-radius: 6px;
      display: inline-block;
      margin-top: 2px;
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }

    input, button {
      padding: 10px;
      font-size: 14px;
      margin: 5px;
    }

    /* Profile pics in chat */
    .message img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .input-container {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
    }

    .input-container input {
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>8th Grade Chat</h1>

  <!-- Google Login -->
  <div id="g_id_onload"
       data-client_id="YOUR_GOOGLE_CLIENT_ID"
       data-context="signin"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse">
  </div>

  <div class="g_id_signin" 
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large">
  </div>

  <!-- Chat container -->
  <div id="messages"></div>

  <div class="input-container">
    <input id="messageInput" type="text" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    const socket = io();
    const messagesContainer = document.getElementById("messages");
    let currentUser = null;

    // Google login callback
    function handleCredentialResponse(response) {
      const base64Url = response.credential.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const payload = JSON.parse(atob(base64));

      currentUser = {
        name: payload.name,
        email: payload.email,
        picture: payload.picture
      };

      alert("Welcome " + currentUser.name);
    }

    // Send a message
    function sendMessage() {
      if (!currentUser) {
        alert("Please sign in with Google first.");
        return;
      }

      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (text === "") return;

      const messageData = {
        username: currentUser.name,
        picture: currentUser.picture,
        content: text,
        timestamp: new Date()
      };

      socket.emit("chat message", messageData);
      input.value = "";
    }

    // Add message to chat
    function addMessage(username, content, timestamp, picture) {
      const messageElement = document.createElement("div");
      messageElement.className = "message";

      if (picture) {
        const img = document.createElement("img");
        img.src = picture;
        img.alt = username;
        messageElement.appendChild(img);
      }

      const contentWrapper = document.createElement("div");

      const header = document.createElement("div");
      header.className = "message-header";
      const time = new Date(timestamp);
      header.textContent = `${username} - ${time.toLocaleTimeString()}`;

      const body = document.createElement("div");
      body.className = "message-content";
      body.textContent = content;

      contentWrapper.appendChild(header);
      contentWrapper.appendChild(body);
      messageElement.appendChild(contentWrapper);

      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Listen for chat events
    socket.on("chat history", (msgs) => {
      messagesContainer.innerHTML = "";
      msgs.forEach(m => addMessage(m.username, m.content, m.timestamp, m.picture));
    });

    socket.on("chat message", (msg) => {
      addMessage(msg.username, msg.content, msg.timestamp, msg.picture);
    });
  </script>
</body>
</html>
